import React, { useEffect, useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { Loader2 } from "lucide-react";

// Components UI
import Button from "@/components/common/Button/Button";
import Toast from "@/components/common/Notification/Toast";
import ToastPortal from "@/components/common/Notification/ToastPortal";
import TabsComponent from "@/components/common/Tabs/TabsComponent";
import EmptyState from "@/components/common/EmptyState/EmptyState";
import AccountMenu from "./AccountMenu";

// Modals
import BookingDetailModal from "./BookingDetailModal";
import CancelBookingModal from "./CancelBookingModal";
import RequestRefundModal from "./RequestRefundModal";
import ReviewBookingModal from "./ReviewBookingModal";

// Services & Context
import bookingService from "@/services/booking.service";
import paymentService from "@/services/payment.service";
import { createRating, getRatingByBooking, updateRating } from "@/services/rating.service";
import { useAuth } from "@/context/AuthContext";

// Component BookingCard
import BookingCard from "./components/BookingCard"; 

const TABS = [
  { id: "upcoming", name: "Sắp tới" },
  { id: "cancelled", name: "Đã hủy" },
  { id: "all", name: "Tất cả" },
];

export default function MyBookings() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();

  // Data States
  const [bookings, setBookings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [toast, setToast] = useState({ show: false, msg: "", type: "info" });
  const [activeTab, setActiveTab] = useState("upcoming");

  // States cho Review
  const [reviewMode, setReviewMode] = useState("create"); // 'create' | 'view'
  const [existingReview, setExistingReview] = useState(null);

  // Modals State
  const [selectedBooking, setSelectedBooking] = useState(null);
  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
  const [isCancelModalOpen, setIsCancelModalOpen] = useState(false);
  const [isRefundModalOpen, setIsRefundModalOpen] = useState(false);
  const [isReviewModalOpen, setIsReviewModalOpen] = useState(false);

  const showToast = (msg, type = "info") => {
    setToast({ show: true, msg, type });
    setTimeout(() => setToast({ show: false, msg: "", type: "info" }), 3000);
  };

  // --- FETCH DATA ---
  const fetchBookings = async () => {
    if (!currentUser) return;
    setLoading(true);
    try {
      const data = await bookingService.getBookingsByUserId(currentUser.userId);
      setBookings((data || []).reverse());
    } catch (err) {
      console.error("Fetch error:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchBookings();
  }, [currentUser]);

  // --- FILTER LOGIC ---
  const filteredBookings = useMemo(() => {
    if (activeTab === "upcoming") {
      return bookings.filter(
        (b) =>
          b.status === "CONFIRMED" ||
          b.status === "PENDING_PAYMENT" ||
          b.status === "CHECKED_IN"
      );
    }
    if (activeTab === "cancelled") {
      return bookings.filter((b) => b.status === "CANCELLED");
    }
    return bookings;
  }, [bookings, activeTab]);

  // --- HANDLERS (Modal Control) ---
  const handleViewDetails = (booking) => {
    setSelectedBooking(booking);
    setIsDetailModalOpen(true);
  };

  const handleStartCancel = (booking) => {
    const targetBooking = booking || selectedBooking;
    setSelectedBooking(targetBooking);
    setIsDetailModalOpen(false);
    setTimeout(() => setIsCancelModalOpen(true), 200);
  };

  // ✅ SỬA LOGIC HỦY & CHUYỂN HOÀN TIỀN
  const handleConfirmCancel = async (booking, reason) => {
    const targetBooking = booking || selectedBooking;
    if (!targetBooking) return;

    try {
        // 1. Gọi API
        await bookingService.cancelBooking(targetBooking.bookingId, reason);
        showToast("Hủy đặt phòng thành công!", "success");

        // 2. Refresh dữ liệu (Loading spinner sẽ hiện ra ở đây, chặn user click lung tung)
        await fetchBookings();

        // 3. Đóng modal hủy
        setIsCancelModalOpen(false);

        // 4. Xử lý hoàn tiền
        const pStatus = targetBooking.paymentStatus;
        // Kiểm tra kỹ các trạng thái có thể coi là đã thanh toán
        const isPaid = pStatus === "APPROVED" || pStatus === "PAID" || pStatus === "COMPLETED";

        if (isPaid) {
            // Delay để modal hủy đóng hẳn rồi mới mở modal hoàn tiền
            setTimeout(() => setIsRefundModalOpen(true), 500);
        } else {
            // ✅ NÊN DÙNG: Delay việc clear data để tránh modal bị giật cục khi đóng
            setTimeout(() => setSelectedBooking(null), 300); 
        }

    } catch (err) {
        console.error("Cancel Error:", err);
        showToast(err.response?.data?.message || err.message || "Lỗi khi hủy đơn.", "error");
    }
};

  const handleOpenRefundModal = (booking) => {
    setSelectedBooking(booking);
    setIsRefundModalOpen(true);
    setIsDetailModalOpen(false);
  };

  // ✅ SỬA LOGIC GỬI YÊU CẦU HOÀN TIỀN
  const handleConfirmRefundRequest = async (bookingId, refundData) => {
    if (!bookingId) return;

    try {
      await paymentService.requestRefund(bookingId, refundData);
      showToast("Đã gửi yêu cầu hoàn tiền thành công!", "success");
      
      await fetchBookings();
      
      // Xong xuôi thì mới đóng modal và reset booking
      setIsRefundModalOpen(false);
      setSelectedBooking(null);

    } catch (err) {
      showToast(err.response?.data?.message || err.message || "Lỗi khi gửi yêu cầu.", "error");
    }
  };

  // --- REVIEW HANDLERS ---
  const handleOpenReviewModal = async (booking) => {
    setSelectedBooking(booking);
    
    const mode = booking.reviewed ? "view" : "create";
    setReviewMode(mode);

    if (mode === "view") {
      try {
        const res = await getRatingByBooking(booking.bookingId);
        const reviewData = res.content ? res.content[0] : (Array.isArray(res) ? res[0] : res);
        
        if (!reviewData) {
             console.warn("Backend says reviewed but no data found.");
             setReviewMode("create");
             setExistingReview(null);
        } else {
             setExistingReview(reviewData);
        }
      } catch (err) {
        console.error("Lỗi tải đánh giá:", err);
        showToast("Không thể tải đánh giá cũ.", "error");
        return; 
      }
    } else {
      setExistingReview(null);
    }

    setIsDetailModalOpen(false); 
    setIsReviewModalOpen(true);
  };

  const handleSubmitReview = async ({ rating, comment, files }) => {
    try {
      if (!selectedBooking || !currentUser) throw new Error("Thiếu thông tin.");
      await createRating({
        bookingId: selectedBooking.bookingId,
        stars: rating,
        comment,
        files,
      });
      showToast("Cảm ơn bạn! Đánh giá đã được gửi thành công.", "success");
      setIsReviewModalOpen(false);
      setSelectedBooking(null);
      fetchBookings(); 
    } catch (err) {
      const uiMessage = err.response?.data?.message || err.message || "Gửi đánh giá thất bại.";
      throw new Error(uiMessage);
    }
  };

  const handleUpdateReview = async (ratingId, { rating, comment, files }) => {
    try {
      await updateRating(ratingId, {
        stars: rating,
        comment,
        files
      });
      showToast("Đánh giá đã được cập nhật!", "success");
      setIsReviewModalOpen(false);
      setSelectedBooking(null);
      fetchBookings(); 
    } catch (err) {
      console.error("Update error:", err);
      const uiMessage = err.response?.data?.message || err.message || "Cập nhật thất bại.";
      throw new Error(uiMessage);
    }
  };

  return (
    <div className="mx-auto max-w-7xl p-6 animate-fade-in">
      <div className="grid grid-cols-1 gap-8 lg:grid-cols-12">
        {/* MENU SIDEBAR */}
        <div className="lg:col-span-3">
          <AccountMenu
            activeSection="my-bookings"
            userData={currentUser}
          />
        </div>

        {/* MAIN CONTENT */}
        <div className="space-y-6 lg:col-span-9">
          <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
            <div>
              <h2 className="text-2xl font-bold text-slate-800">Đặt chỗ của tôi</h2>
              <p className="text-sm text-slate-500">
                Quản lý các chuyến đi sắp tới và lịch sử đặt phòng.
              </p>
            </div>
          </div>

          <div className="border-b border-slate-200">
            <TabsComponent
              tabs={TABS}
              activeTab={activeTab}
              onTabChange={setActiveTab}
            />
          </div>

          {loading ? (
            <div className="flex justify-center py-20">
              <Loader2 className="h-10 w-10 animate-spin text-blue-600" />
            </div>
          ) : filteredBookings.length === 0 ? (
            <div className="py-10">
              <EmptyState
                title="Chưa có đơn đặt phòng nào"
                description="Bạn chưa có chuyến đi nào trong mục này."
              />
              <div className="mt-6 text-center">
                <Button size="lg" onClick={() => navigate("/hotels")}>
                  Tìm khách sạn ngay
                </Button>
              </div>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredBookings.map((b) => (
                <BookingCard
                  key={b.bookingId}
                  booking={b}
                  onClick={() => handleViewDetails(b)}
                  onReviewClick={() => handleOpenReviewModal(b)} 
                />
              ))}
            </div>
          )}
        </div>
      </div>

      {/* --- TOAST --- */}
      <ToastPortal>
        {toast.show && (
          <div className="fixed bottom-6 left-1/2 z-[9999] -translate-x-1/2">
            <Toast message={toast.msg} type={toast.type} />
          </div>
        )}
      </ToastPortal>

      {/* --- DETAIL MODAL --- */}
      <BookingDetailModal
        isOpen={isDetailModalOpen}
        onClose={() => setIsDetailModalOpen(false)}
        booking={selectedBooking}
        onCancelClick={() => handleStartCancel(selectedBooking)}
        onRefundClick={() => handleOpenRefundModal(selectedBooking)}
        onReviewClick={() => handleOpenReviewModal(selectedBooking)} 
      />

      {/* --- CANCEL MODAL --- */}
      <CancelBookingModal
        open={isCancelModalOpen}
        onClose={() => {
            setIsCancelModalOpen(false);
            // Chỉ reset khi đóng tay (không phải đang chuyển sang hoàn tiền)
            if (!isRefundModalOpen) setSelectedBooking(null); 
        }}
        // Wrapper xử lý gộp lý do
        onConfirm={async (reason, otherReason) => {
            const finalReason = otherReason ? `${reason}: ${otherReason}` : reason;
            await handleConfirmCancel(selectedBooking, finalReason);
        }}
        booking={selectedBooking}
      />

      {/* --- REFUND MODAL --- */}
      <RequestRefundModal
        isOpen={isRefundModalOpen}
        onClose={() => {
            setIsRefundModalOpen(false);
            setSelectedBooking(null); // Đóng xong mới reset
        }}
        // Gọi hàm với đúng 2 tham số: ID và Data
        onConfirm={(data) => handleConfirmRefundRequest(selectedBooking?.bookingId, data)}
        booking={selectedBooking}
      />

      {/* --- REVIEW MODAL --- */}
      <ReviewBookingModal
        isOpen={isReviewModalOpen}
        onClose={() => setIsReviewModalOpen(false)}
        booking={selectedBooking}
        onSubmit={handleSubmitReview} 
        onUpdate={handleUpdateReview} 
        mode={reviewMode}             
        initialData={existingReview}  
      />
    </div>
  );
}